<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="Keywords" content="">
    <meta name="full-screen" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#006cb4">
    <meta name="apple-mobile-web-app-title" content="TOM&#39;s zone">
    <meta name="description" content="TOM&#39;s zone">
    <link rel="dns-prefetch" href="https://hasaki.xyz">
    <link rel="preconnect" href="https://hasaki.xyz">
    <link rel="manifest" href="/sw/manifest.json"/>
<title>使用 nextcloud 搭建个人私有网盘 - TOM&#39;s zone</title>

<meta name="description" content="国内各大云网盘要么限速要么需要充值 vip 、超级 vip、超超级 vip。
国外的一些优质云网盘如 google drive 和 one drive 等由于和谐因素又无法顺利的访问。
本来想买个 nas ，看到价格和组 raid 的成本放弃了。
刚好我有一台新组装的主机电脑，平时也是偶尔开着，所以特意买了个 2t 的希捷数据盘，准备搭建一套私有云的环境给家庭用。
开源云盘选择  其实在搭建之前，考虑过自己写一个简单的文件系统上传预览，后来发现需要考虑的问题太多卒🤣
 搭建前我仔细看了一下各个开源私有云盘的实现，有以下几种：
 owncloud sealife nextcloud  对这几家比较了以下，考虑了以下因素：
 开源且免费，可以自定义插件开发 全客户端的支持，免费更好，ui 视觉还能过得去 支持外挂磁盘，可以随时更改，不需要分块、加密和过多的文件控制、权限控制等等，简单就好 部署难度，vm 还行，最好可以 Docker  最终我选择了 nextcloud，至于更多的详细差异，大家可以根据需求选择。
内网穿透 由于家里的电信没有外网 ip ，打电话给运营商也无济于事，只能选择内网穿透。
内网穿透选择了很多办法：
 根据开源实现自己部署到一台公共可访问的服务器上，比如：frp、ngrok等等 使用现有的内网穿透服务商，比如：花生壳、natapp 等等  最终我选择了 natapp 免费使用版
开始搭建 我个人的网盘需求只是偶尔让我爸妈把照片上传到我的主机上。
对性能、速度、可持续性都没有太高的要求，所以很多条件都可以简化，只要保证数据完整性就可以了。
首先在 Windows 上安装所需要的环境： Docker 、Python 等。并且在 E 盘下创建了特定的 nas 文件夹来作为 nextcloud 的目录。">




    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Raleway">


    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/ocean.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/javascript.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/python.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/go.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/css.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/swift.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/objectivec.min.js"></script>


    <link rel="stylesheet" href="/css/bundle.min.css"/>
<script src="/js/bundle.min.js"></script>
<style>
	a { color: #ff8181; }
	blockquote {
		border-left-color: #ff8181;
		border-right-color: #ff8181; }
	.bar a:hover {
		color: #ff8181;
		text-decoration: none; }
	.sep {
		margin-top: 2rem;
		margin-bottom: 1rem;
		margin-left:0;
		width: 24rem;
		border-top: 2px solid #ff8181; }
    .bar li.active a{
        color:#ff8181;
    }
</style>

</head>

<body>
<header class="container no-print">
	<div class="u-header">
		<nav class="bar">
	<ul><li>
			<a href="/">
				<img class="icon-text" src="/img/prev.svg"/>
			</a>
		</li>
		
		<li class="active"><a href="/blog/">Blog</a></li></ul>
</nav>

	</div>
</header>
<main class="container">

<article>
    <header><hgroup id="brand">
	<h1>使用 nextcloud 搭建个人私有网盘</h1>
	<h5>
		
		<time datetime="2019-02-12 10:58:40 &#43;0800 CST">Feb 12, 2019</time>
		<span class="no-print">
			-
			
			<a href="/tags/docker">Docker</a>
			
			<a href="/tags/%e6%8a%98%e8%85%be">折腾</a>
			</span>
	</h5>

	
	<a style="margin-top: 1.2rem;display: inline-block;" href="https://github.com/V-Tom/blog/blob/hugo/content/blog/2019-02-12-%E4%BD%BF%E7%94%A8%20nextcloud%20%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%A7%81%E6%9C%89%E7%BD%91%E7%9B%98/index.md">✨✨✨You can Edit this Article on Github</a>
	
	
	
</hgroup>
<hr class="sep" /></header>
    <section id="markdown">
        

<p>国内各大云网盘要么限速要么需要充值 vip 、超级 vip、超超级 vip。</p>

<p>国外的一些优质云网盘如 <code>google drive</code> 和 <code>one drive</code> 等由于和谐因素又无法顺利的访问。</p>

<p>本来想买个 <code>nas</code> ，看到价格和组 <code>raid</code> 的成本放弃了。</p>

<p>刚好我有一台新组装的主机电脑，平时也是偶尔开着，所以特意买了个 <code>2t</code> 的希捷数据盘，准备搭建一套私有云的环境给家庭用。</p>

<h3 id="开源云盘选择">开源云盘选择</h3>

<blockquote>
<p>其实在搭建之前，考虑过自己写一个简单的文件系统上传预览，后来发现需要考虑的问题太多卒🤣</p>
</blockquote>

<p>搭建前我仔细看了一下各个开源私有云盘的实现，有以下几种：</p>

<ul>
<li>owncloud</li>
<li>sealife</li>
<li>nextcloud</li>
</ul>

<p>对这几家比较了以下，考虑了以下因素：</p>

<ul>
<li>开源且免费，可以自定义插件开发</li>
<li>全客户端的支持，免费更好，ui 视觉还能过得去</li>
<li>支持外挂磁盘，可以随时更改，不需要分块、加密和过多的文件控制、权限控制等等，简单就好</li>
<li>部署难度，vm 还行，最好可以 Docker</li>
</ul>

<p>最终我选择了 <code>nextcloud</code>，至于更多的详细差异，大家可以根据需求选择。</p>

<h3 id="内网穿透">内网穿透</h3>

<p>由于家里的电信没有外网 ip ，打电话给运营商也无济于事，只能选择内网穿透。</p>

<p>内网穿透选择了很多办法：</p>

<ul>
<li>根据开源实现自己部署到一台公共可访问的服务器上，比如：frp、ngrok等等</li>
<li>使用现有的内网穿透服务商，比如：花生壳、natapp 等等</li>
</ul>

<p>最终我选择了 natapp 免费使用版</p>

<h3 id="开始搭建">开始搭建</h3>

<p>我个人的网盘需求只是偶尔让我爸妈把照片上传到我的主机上。</p>

<p>对性能、速度、可持续性都没有太高的要求，所以很多条件都可以简化，只要保证数据完整性就可以了。</p>

<p>首先在 Windows 上安装所需要的环境： <code>Docker</code> 、<code>Python</code> 等。并且在 <code>E</code> 盘下创建了特定的 <code>nas</code> 文件夹来作为 <code>nextcloud</code> 的目录。</p>

<h3 id="配置-docker">配置 Docker</h3>

<p>创建 <code>docker-compose.yml</code> 文件来配置 <code>Docker</code> ：</p>

<pre><code class="language-yaml">
version: '2'

volumes:
  data:
  config:
  apps:

services:

  app:
    image: nextcloud
    ports:
      - 8080:80
    volumes:
      - ./data:/var/www/html/data
      - ./config:/var/www/html/config
      - ./apps:/var/www/html/apps

      # 外挂磁盘 /e/nas/extend-disk/ 作为初始数据源
      - /e/nas/extend-disk/:/home

    restart: always

</code></pre>

    </section>
    <nav class="no-print post-nav">
        
        <a class="prev-post" href="https://hasaki.xyz/blog/working-tips/">
            <img class="icon-text" src="/img/prev.svg"/>working tips</a>
        
        
        <a class="next-post" href="https://hasaki.xyz/blog/2019-03-04-grpc-%E6%B5%85%E8%B0%88%E4%B8%8E%E5%AE%9E%E8%B7%B5/">gRPC 浅谈与实践<img class="icon-text" src="/img/next.svg"/>
        </a>
        
    </nav>
</article>



<div id="disqus_thread" class="no-print"></div>
<script type="text/javascript">
    'use strict';
    (function () {
        if ('localhost' != window.location.hostname) {
            var a = document.querySelector('#disqus_thread');
            new IntersectionObserver(function (b) {
                b.forEach(function (d) {
                    if (0 < d.intersectionRatio && !a.classList.contains('active')) {
                        var e = document.createElement('script');
                        e.type = 'text/javascript', e.async = !0;
                        e.src = '//' + 'hasaki-xyz' + '.disqus.com/embed.js', (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(e), a.classList.add('active')
                    }
                })
            }, {rootMargin: '0px', threshold: 1}).observe(a)
        }
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>


<style rel="catalog">
    #catalog {
        position: fixed;
        left: 3vw;
        top: 8vh;
    }

    .cl-wrapper {
        position: relative;
    }

    .cl-wrapper ul, .cl-wrapper li {
        margin: 0;
        -moz-padding-start: 12px;
        -webkit-padding-start: 12px;
        list-style: none;
    }

    .cl-wrapper li > .cl-link.cl-link-active {
        color: #ff8181;
        transition: .5s;
    }

    .cl-wrapper li > .cl-transform.cl-link-active {
        transform: translate(3px);
    }

    .cl-wrapper .cl-link {
        cursor: pointer;
        color: rgba(52, 73, 94, 0.5);
        font-size: 13px;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .cl-wrapper .cl-marker {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }

    .cl-wrapper .cl-marker path {
        transition: all 0.3s ease;
    }
</style>
<main id="catalog"></main>
<script rel="catalog">
    void function () {
        
        if (window.innerWidth < 1024 || /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            return
        }

        const Catalog = (function () {
            return function (opts) {
                let defaultOpts = {
                    linkClass: 'cl-link',                             
                    linkActiveClass: 'cl-link-active',                
                    datasetName: 'data-cata-target',                  
                    selector: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'],   
                    scrollWrapper: null,                              
                    activeHook: null,                                 
                    topMargin: 0,
                    bottomMargin: 0,
                    cool: true                                        
                }

                const Opt = Object.assign({}, defaultOpts, opts)

                const $content = document.getElementById(Opt.contentEl)                          
                const $scroll_wrap = window   
                const $catalog = document.getElementById(Opt.catalogEl)                          

                let allCatalogs = $content.querySelectorAll(Opt.selector.join())
                let tree = getCatalogsTree(allCatalogs)

                try {
                    $catalog.innerHTML = `<div class='cl-wrapper'>${generateHtmlTree(tree, {id: -1})}<svg class="cl-marker" width="200" height="200" xmlns="http://www.w3.org/2000/svg">
            <path stroke="#ff8181" stroke-width="3" fill="transparent" stroke-dasharray="0, 0, 0, 1000" stroke-linecap="round" stroke-linejoin="round" transform="translate(-0.5, -0.5)" />
            </svg></div>`
                } catch (e) {
                    console.error('error in progress-catalog', e)
                }


                const tocPath = $catalog.querySelector('.cl-marker path')
                let tocItems, pathLength    

                
                window.addEventListener('resize', drawPath)
                $catalog.addEventListener('click', clickHandler)
                Opt.cool && $scroll_wrap.addEventListener('scroll', coolScrollHandler)
                Opt.cool || $scroll_wrap.addEventListener('scroll', simpleScrollHandler)

                setTimeout(drawPath)          

                

                function drawPath() {
                    tocItems = [...$catalog.querySelectorAll('li')]
                    tocItems = tocItems.map(function (liDom) {
                        const anchor = liDom.querySelector(`.${Opt.linkClass}`)
                        const target = document.getElementById(anchor.getAttribute('data-cata-target'))

                        return {
                            listItem: liDom,
                            anchor: anchor,
                            target: target
                        }
                    })
                    tocItems = tocItems.filter(item => !!item.target)

                    const path = []
                    let pathIndent

                    tocItems && tocItems.forEach(function (item, idx) {
                        const {offsetLeft, offsetTop, offsetHeight} = item.anchor,
                            x = Opt.cool ? offsetLeft - 5 : offsetLeft,
                            y = offsetTop,
                            height = offsetHeight

                        if (idx === 0) {
                            path.push('M', x, y, 'L', x, y + height)
                            item.pathStart = 0
                        }
                        else {
                            if (pathIndent !== x) path.push('L', pathIndent, y)     
                            path.push('L', x, y)
                            tocPath.setAttribute('d', path.join(' '))
                            item.pathStart = tocPath.getTotalLength() || 0
                            path.push('L', x, y + height)
                        }
                        pathIndent = x
                        tocPath.setAttribute('d', path.join(' '))
                        item.pathEnd = tocPath.getTotalLength()
                    })
                    pathLength = tocPath.getTotalLength()
                    coolScrollHandler()
                }

                

                function coolScrollHandler() {
                    const wrapHeight = document.documentElement.offsetHeight
                    let pathStart = pathLength,
                        pathEnd = 0,
                        visibleItems = 0
                    tocItems.forEach(function (liItem) {
                        const {bottom, top} = liItem.target.getBoundingClientRect(),
                            firstChild = liItem.listItem.firstChild
                        if (bottom > Opt.topMargin && top < wrapHeight - Opt.bottomMargin) {
                            firstChild.classList.remove(Opt.linkActiveClass)
                            Opt.cool && firstChild.classList.remove('cl-transform')
                        } else {
                            pathStart = Math.min(liItem.pathStart, pathStart)
                            pathEnd = Math.max(liItem.pathEnd, pathEnd)
                            visibleItems += 1
                            firstChild.classList.add(Opt.linkActiveClass)
                            Opt.cool && firstChild.classList.add('cl-transform')
                        }
                    })
                    if (visibleItems > 0 && pathStart < pathEnd && Opt.cool) {
                        tocPath.setAttribute('stroke-dashoffset', '1')
                        tocPath.setAttribute('stroke-dasharray', `1, ${pathStart}, ${pathEnd - pathStart}, ${pathLength}`)
                        tocPath.setAttribute('opacity', '1')
                    }
                    else {
                        tocPath.setAttribute('opacity', '0')
                    }
                }

                

                function simpleScrollHandler(el) {
                    let scrollToEl = null
                    for (let i = allCatalogs.length - 1; i >= 0; i--) {
                        if (allCatalogs[i].offsetTop <= $scroll_wrap.scrollTop) {
                            scrollToEl = allCatalogs[i]
                            break
                        }
                    }
                    if (scrollToEl) setActiveItem(scrollToEl.id)
                    else setActiveItem(null)            
                }

                

                function clickHandler({target}) {
                    const datasetId = target.getAttribute(Opt.datasetName)
                    target.classList.contains(Opt.linkClass) &&
                    document.getElementById(datasetId)
                        .scrollIntoView({behavior: "smooth", block: "start"})
                }

                

                function getCatalogsTree(catalogs) {
                    let title, tagName, tree = [], treeItem = {}, parentItem = {id: -1}, lastTreeItem = null, id

                    for (let i = 0; i < catalogs.length; i++) {
                        title = catalogs[i].innerText || catalogs[i].textContent
                        tagName = catalogs[i].tagName
                        id = 'heading-' + i
                        catalogs[i].id = id
                        treeItem = {
                            name: title,
                            tagName: tagName,
                            id: id,
                            level: +getLevel(tagName),
                            parent: parentItem
                        }
                        if (lastTreeItem) {
                            if (getLevel(treeItem.tagName) > getLevel(lastTreeItem.tagName)) {
                                treeItem.parent = lastTreeItem
                            } else {
                                treeItem.parent = findParent(treeItem, lastTreeItem)
                            }
                        }
                        lastTreeItem = treeItem
                        tree.push(treeItem)
                    }
                    return tree
                }

                

                function findParent(currTreeItem, lastTreeItem) {
                    let lastTreeParent = lastTreeItem.parent
                    while (lastTreeParent && (getLevel(currTreeItem.tagName) <= getLevel(lastTreeParent.tagName))) {
                        lastTreeParent = lastTreeParent.parent
                    }
                    return lastTreeParent || {id: -1}
                }

                

                function getLevel(tagName) {
                    return tagName ? tagName.slice(1) : 0
                }

                

                function generateHtmlTree(tree, _parent) {
                    let ul, hasChild = false
                    if (tree) {
                        ul = `<ul>`
                        for (let i = 0; i < tree.length; i++) {
                            if (isEqual(tree[i].parent, _parent)) {
                                hasChild = true
                                ul += `<li><div class='${ Opt.linkClass } cl-level-${ tree[i].level }' ${Opt.datasetName}='${ tree[i].id }'>${tree[i].name}</div>`
                                ul += generateHtmlTree(tree, tree[i])
                                ul += '</li>'
                            }
                        }
                        ul += `</ul>`
                    }
                    return hasChild ? ul : ''
                }

                /**
                 * 判断是否是相同节点
                 */
                function isEqual(node, node2) {
                    return node && node2 && typeof node === 'object' && typeof node2 === 'object' && node.id === node2.id
                }

                /**
                 *  设置选中的项
                 */
                function setActiveItem(id) {
                    let catas = [...$catalog.querySelectorAll(`[${Opt.datasetName}]`)]

                    catas.forEach(T => {
                        if (T.getAttribute(Opt.datasetName) === id) {
                            typeof Opt.activeHook === 'function' &&
                            !T.classList.contains(Opt.linkActiveClass) &&
                            Opt.activeHook.call(this, T)                    // 执行active钩子
                            T.classList.add(Opt.linkActiveClass)
                        } else {
                            T.classList.remove(Opt.linkActiveClass)
                        }
                    })
                }
            }
        })();
        window.addEventListener('DOMContentLoaded', _ => new Catalog({
            contentEl: 'markdown',
            catalogEl: 'catalog'
        }))
    }();
</script>
			<hr class="sep" />
		</main>
		<footer class="container no-print">
			<div class="u-footer">
				
<a href="mailto:iamnomand@gmail.com"><img class="icon-social" src="/img/email.svg" alt="Email Me!"/></a>


<a href="https://github.com/v-tom/"><img class="icon-social" src="/img/github.svg" alt="Github"/></a>


<a href="https://twitter.com/iamnomand"><img class="icon-social" src="/img/twitter.svg" alt="Twitter"/></a>

<a href="https://hasaki.xyz/index.xml" target="_blank"><img class="icon-social" src="/img/feed.svg" alt="Feed"></a>

				<p>
					
					
					Early 2016 ~ 2019 &copy; TOM's Zone
					
					
				</p>
				
				<a href="#brand">
					<img class="icon-text" src="/img/toup.svg" alt="To Up"/>
					<span>Back to Up</span>
				</a>
				
			</div>
		</footer>
		
		<script>hljs.initHighlightingOnLoad();</script>
		
	</body>
</html>

